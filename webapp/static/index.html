<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Kingsday Arena</title>
  <style>
    :root {
      --bg-0: #fdf6e7;
      --bg-1: #f6fbff;
      --ink: #1f2a37;
      --muted: #5f6f85;
      --panel: #ffffffd9;
      --panel-strong: #ffffff;
      --line: #d5deec;
      --accent: #e8602f;
      --accent-2: #0a6a86;
      --ok: #1e7b3f;
      --warn: #925f14;
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      min-height: 100vh;
      color: var(--ink);
      font-family: "Avenir Next", "SF Pro Display", "PingFang SC", "Noto Sans SC", sans-serif;
      background:
        radial-gradient(circle at 20% 10%, #ffe6bf 0, transparent 34%),
        radial-gradient(circle at 82% 16%, #d8f0ff 0, transparent 30%),
        linear-gradient(145deg, var(--bg-0), var(--bg-1));
    }

    .app {
      max-width: 1400px;
      margin: 0 auto;
      padding: 16px;
      display: grid;
      gap: 14px;
      grid-template-rows: auto 1fr auto;
      min-height: 100vh;
    }

    .card {
      background: var(--panel);
      border: 1px solid var(--line);
      border-radius: 14px;
      backdrop-filter: blur(4px);
      box-shadow: 0 10px 24px #2a3b5711;
    }

    .topbar {
      display: grid;
      grid-template-columns: 1fr auto;
      gap: 12px;
      padding: 12px;
      align-items: center;
    }

    .title {
      font-size: 22px;
      font-weight: 700;
      letter-spacing: .03em;
    }

    .meta { display: flex; gap: 8px; flex-wrap: wrap; margin-top: 6px; }

    .pill {
      display: inline-flex;
      align-items: center;
      padding: 4px 10px;
      border-radius: 999px;
      border: 1px solid var(--line);
      background: #fff;
      color: var(--muted);
      font-size: 12px;
    }

    .row { display: flex; flex-wrap: wrap; gap: 8px; }

    button {
      border: 1px solid var(--line);
      border-radius: 10px;
      background: #fff;
      padding: 8px 12px;
      font-weight: 600;
      color: var(--ink);
      cursor: pointer;
    }

    button.primary { background: var(--accent); color: #fff; border-color: #ca4e22; }
    button.secondary { background: var(--accent-2); color: #fff; border-color: #07556b; }
    button.warn { background: #fff7ee; border-color: #efccab; color: var(--warn); }
    button:disabled { opacity: .5; cursor: not-allowed; }

    .board-wrap {
      display: grid;
      grid-template-columns: 320px 1fr;
      gap: 12px;
      min-height: 560px;
    }

    .setup {
      padding: 12px;
      overflow: auto;
    }

    .section-title { font-size: 16px; font-weight: 700; margin-bottom: 8px; }

    .setup-list {
      display: grid;
      gap: 6px;
      max-height: 360px;
      overflow: auto;
      padding-right: 4px;
    }

    .setup-item {
      display: flex;
      gap: 8px;
      align-items: center;
      font-size: 13px;
      color: var(--muted);
    }

    .arena {
      position: relative;
      min-height: 560px;
      background: linear-gradient(180deg, #f5fbff, #eef7ff);
      border-radius: 16px;
      border: 1px solid var(--line);
      overflow: hidden;
    }

    .arena::before {
      content: "";
      position: absolute;
      inset: 8% 12%;
      border-radius: 999px;
      border: 2px dashed #ced9ea;
      opacity: 0.7;
      pointer-events: none;
    }

    .center-panel {
      position: absolute;
      left: 50%;
      top: 50%;
      transform: translate(-50%, -50%);
      width: min(360px, 52vw);
      background: var(--panel-strong);
      border: 1px solid var(--line);
      border-radius: 16px;
      padding: 12px;
      z-index: 4;
      box-shadow: 0 12px 26px #233b6522;
    }

    .center-label { color: var(--muted); font-size: 12px; }
    .center-title { font-size: 16px; font-weight: 700; margin: 4px 0 6px; }

    .actions { margin-top: 8px; }

    .role-node {
      position: absolute;
      width: 220px;
      min-height: 140px;
      transform: translate(-50%, -50%);
      background: var(--panel-strong);
      border: 1px solid var(--line);
      border-radius: 14px;
      padding: 10px;
      z-index: 3;
      box-shadow: 0 8px 16px #2f466711;
      transition: transform .2s ease, box-shadow .2s ease;
    }

    .role-node.current {
      box-shadow: 0 0 0 2px #f6b49f, 0 10px 22px #d86a3c33;
    }

    .role-title { font-weight: 700; font-size: 14px; }
    .role-sub { color: var(--muted); font-size: 11px; margin-bottom: 4px; }
    .mini { color: var(--muted); font-size: 11px; line-height: 1.35; }
    .stats {
      margin: 6px 0;
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 3px 8px;
    }
    .stat { font-size: 12px; color: var(--ink); }

    .logs {
      padding: 12px;
      background: #0e1726;
      border: 1px solid #22344f;
      border-radius: 12px;
      color: #e0edff;
      font-family: "Menlo", "SFMono-Regular", monospace;
      font-size: 12px;
      line-height: 1.45;
      max-height: 210px;
      overflow: auto;
      white-space: pre-wrap;
    }

    .hint { font-size: 12px; color: var(--muted); }

    @media (max-width: 1160px) {
      .board-wrap { grid-template-columns: 1fr; }
      .arena { min-height: 780px; }
      .center-panel { width: min(420px, 80vw); }
    }

    @media (max-width: 680px) {
      .role-node { width: 178px; min-height: 126px; }
      .arena::before { inset: 16% 10%; }
    }
  </style>
</head>
<body>
  <div class="app">
    <header class="card topbar">
      <div>
        <div class="title">Kingsday Circle Table</div>
        <div id="meta" class="meta"></div>
      </div>
      <div class="row">
        <button id="modeManual" class="secondary">手动模式</button>
        <button id="modeAuto">自动模式</button>
        <button id="stepBtn">自动走一步</button>
        <button id="resetBtn" class="warn">重置</button>
      </div>
    </header>

    <main class="board-wrap">
      <aside id="setup" class="card setup">
        <div class="section-title">开局配置</div>
        <div id="roleChecklist" class="setup-list"></div>
        <div class="row" style="margin-top: 10px;">
          <button id="startBtn" class="primary">开始游戏</button>
        </div>
        <div class="hint" style="margin-top: 10px;">Finn 与 游客固定必选。</div>
      </aside>

      <section class="arena" id="arena">
        <div class="center-panel">
          <div class="center-label">中央事件区 / 即时状态</div>
          <div id="centerEvent" class="center-title">等待开局</div>
          <div id="centerTurn" class="hint"></div>
          <div id="actions" class="actions row"></div>
        </div>
      </section>
    </main>

    <section class="logs" id="logs"></section>
  </div>

  <script>
    const state = {
      roles: [],
      game: null,
      mode: 'manual',
      autoTimer: null,
      busy: false,
    };

    const dom = {
      meta: document.getElementById('meta'),
      setup: document.getElementById('setup'),
      roleChecklist: document.getElementById('roleChecklist'),
      startBtn: document.getElementById('startBtn'),
      resetBtn: document.getElementById('resetBtn'),
      modeManual: document.getElementById('modeManual'),
      modeAuto: document.getElementById('modeAuto'),
      stepBtn: document.getElementById('stepBtn'),
      arena: document.getElementById('arena'),
      centerEvent: document.getElementById('centerEvent'),
      centerTurn: document.getElementById('centerTurn'),
      actions: document.getElementById('actions'),
      logs: document.getElementById('logs'),
    };

    const RES_ORDER = ['stamina', 'curiosity', 'money', 'product', 'orange_product', 'orange_wear_product', 'progress'];

    async function api(path, options = {}) {
      const res = await fetch(path, {
        headers: { 'Content-Type': 'application/json' },
        ...options,
      });
      if (!res.ok) {
        const text = await res.text();
        throw new Error(text || `HTTP ${res.status}`);
      }
      return res.json();
    }

    function roleNameById(id) {
      return (state.game?.players || []).find(p => p.role_id === id)?.role_name || id;
    }

    function updateModeButtons() {
      dom.modeManual.className = state.mode === 'manual' ? 'secondary' : '';
      dom.modeAuto.className = state.mode === 'auto' ? 'secondary' : '';
    }

    function setMode(mode) {
      state.mode = mode;
      updateModeButtons();
      if (state.autoTimer) {
        clearInterval(state.autoTimer);
        state.autoTimer = null;
      }
      if (mode === 'auto') {
        state.autoTimer = setInterval(autoTick, 650);
      }
    }

    function renderMeta() {
      const g = state.game;
      dom.meta.innerHTML = '';
      if (!g) return;

      const items = [
        `回合 ${g.rounds_completed}`,
        `事件 ${g.events_drawn}`,
        g.game_over ? `已结束: ${g.game_over_reason || 'unknown'}` : '进行中',
        state.mode === 'auto' ? '自动模式' : '手动模式',
      ];
      items.forEach(t => {
        const el = document.createElement('span');
        el.className = 'pill';
        el.textContent = t;
        dom.meta.appendChild(el);
      });
    }

    function renderSetup() {
      dom.roleChecklist.innerHTML = '';
      state.roles.forEach(r => {
        const required = r.id === 'role_finn' || r.id === 'role_tourist';
        const row = document.createElement('label');
        row.className = 'setup-item';
        row.innerHTML = `
          <input type="checkbox" value="${r.id}" ${required ? 'checked disabled' : ''} />
          <span>${r.name} (${r.id})</span>
        `;
        dom.roleChecklist.appendChild(row);
      });
    }

    function renderArenaPlayers() {
      dom.arena.querySelectorAll('.role-node').forEach(el => el.remove());
      const players = state.game?.players || [];
      const n = players.length;
      if (!n) return;

      const arenaRect = dom.arena.getBoundingClientRect();
      const w = arenaRect.width;
      const h = arenaRect.height;
      const cx = w / 2;
      const cy = h / 2;
      const rx = Math.max(180, Math.min(w * 0.38, 420));
      const ry = Math.max(160, Math.min(h * 0.34, 300));
      const currentId = state.game?.ui?.role_id;

      players.forEach((p, i) => {
        const angle = (-Math.PI / 2) + (2 * Math.PI * i / n);
        const x = cx + rx * Math.cos(angle);
        const y = cy + ry * Math.sin(angle);

        const el = document.createElement('article');
        el.className = `role-node${p.role_id === currentId ? ' current' : ''}`;
        el.style.left = `${x}px`;
        el.style.top = `${y}px`;

        const st = p.status || {};
        const stats = RES_ORDER
          .filter(k => Object.prototype.hasOwnProperty.call(st, k))
          .map(k => `<div class="stat">${k}: ${st[k]}</div>`)
          .join('');
        const extra = Object.keys(st)
          .filter(k => !RES_ORDER.includes(k))
          .sort()
          .map(k => `<div class="stat">${k}: ${st[k]}</div>`)
          .join('');

        const roleMeta = p.role_meta || {};
        const skill = roleMeta.active_skill || {};
        const drawLogic = roleMeta.draw_logic || 'THEN';
        const drawOptions = Array.isArray(roleMeta.draw_options) ? roleMeta.draw_options : [];
        const drawText = drawOptions.map(opt => {
          const costs = Array.isArray(opt.costs) ? opt.costs : [opt];
          return costs.map(c => `${c.resource}${c.delta}`).join(' + ');
        }).join(drawLogic === 'OR' ? ' / ' : ' THEN ');

        el.innerHTML = `
          <div class="role-title">${p.role_name}</div>
          <div class="role-sub">${p.role_id}</div>
          <div class="stats">${stats}${extra}</div>
          <div class="mini">能力: ${skill.id || '无'}</div>
          <div class="mini">抽卡(${drawLogic}): ${drawText || '无'}</div>
          ${p.win_game ? '<div class="mini" style="color:var(--ok);">已达成胜利条件</div>' : ''}
        `;

        dom.arena.appendChild(el);
      });
    }

    function addAction(label, action, params = {}, cls = '') {
      const b = document.createElement('button');
      b.textContent = label;
      if (cls) b.className = cls;
      b.onclick = async () => doAction(action, params);
      dom.actions.appendChild(b);
    }

    function renderActions() {
      dom.actions.innerHTML = '';
      const g = state.game;
      if (!g?.game_started) {
        dom.centerTurn.textContent = '请先选择角色并开始游戏';
        dom.centerEvent.textContent = '等待开局';
        return;
      }

      const ui = g.ui || {};
      const mode = ui.ui_mode || 'TURN';
      const ev = g.event_info || {};
      dom.centerEvent.textContent = ev.name ? `${ev.name} (${ev.id || '-'})` : '暂无事件';
      dom.centerTurn.textContent = `当前角色: ${ui.role_name || '-'} | 阶段: ${mode}`;

      if (g.game_over) {
        addAction('重开一局', 'noop', {}, 'warn');
        dom.actions.lastChild.onclick = async () => {
          await api('/api/game/reset', { method: 'POST', body: '{}' });
          await refreshState();
        };
        return;
      }

      switch (mode) {
        case 'TURN':
          if (ui.can_draw) addAction('抽事件卡', 'request_draw', {}, 'primary');
          addAction('不抽卡', 'request_no_draw_choice');
          addAction('跳过', 'skip_turn');
          return;
        case 'NO_DRAW_CHOICE':
          if (ui.has_skill) addAction('使用主动技能', 'use_active_skill', {}, 'secondary');
          addAction('跳过', 'skip_turn');
          return;
        case 'DRAW_COST_CHOICE':
          (ui.choices || []).forEach((opt, idx) => {
            const txt = (opt.costs || []).map(c => `${c.resource}${c.delta}`).join(', ');
            addAction(`支付 ${txt}`, 'choose_draw_cost', { index: idx });
          });
          return;
        case 'EVENT_NEED_TARGET':
          (ui.targets || []).forEach(id => addAction(`目标: ${roleNameById(id)}`, 'event_choose_target', { target_id: id }));
          return;
        case 'WATCH_DECIDE':
          addAction(`让 ${roleNameById(ui.target_id)} 围观`, 'watch_decide', { target_id: ui.target_id, watch: true }, 'secondary');
          addAction(`让 ${roleNameById(ui.target_id)} 不围观`, 'watch_decide', { target_id: ui.target_id, watch: false });
          return;
        case 'PHOTO_NEED_TARGET':
        case 'WEAR_NEED_TARGET':
          (ui.targets || []).forEach(id => addAction(`选择 ${roleNameById(id)}`, 'photo_choose_target', { target_id: id }));
          return;
        case 'PHOTO_NEED_CONSENT':
          addAction('同意拍照', 'photo_consent', { agree: true }, 'secondary');
          addAction('拒绝拍照', 'photo_consent', { agree: false });
          return;
        case 'TRADE_NEED_ITEM':
          (ui.items || []).forEach((item, idx) => addAction(`卖 ${item.label || item.key || idx}`, 'trade_choose_item', { item_index: idx }));
          return;
        case 'TRADE_NEED_PARTNER':
          (ui.partners || []).forEach(id => addAction(`交易给 ${roleNameById(id)}`, 'trade_choose_partner', { partner_id: id }));
          return;
        case 'TRADE_NEED_CONSENT':
          addAction('同意交易', 'trade_consent', { agree: true }, 'secondary');
          addAction('拒绝交易', 'trade_consent', { agree: false });
          return;
        case 'FOOD_OFFER_DECIDE':
        case 'FOOD_OFFER_FORCE':
          addAction('接受供餐', 'food_offer_decide', { target_id: ui.target_id, accept: true }, 'secondary');
          if (mode !== 'FOOD_OFFER_FORCE') addAction('拒绝供餐', 'food_offer_decide', { target_id: ui.target_id, accept: false });
          return;
        case 'PERFORM_WATCH_DECIDE':
          addAction('围观', 'perform_watch_decide', { target_id: ui.target_id, watch: true }, 'secondary');
          addAction('不围观', 'perform_watch_decide', { target_id: ui.target_id, watch: false });
          return;
        case 'PERFORM_WATCH_BENEFIT':
          addAction('体力收益', 'perform_watch_benefit', { target_id: ui.target_id, choice: 'stamina' });
          addAction('金钱收益', 'perform_watch_benefit', { target_id: ui.target_id, choice: 'money' }, 'secondary');
          return;
        case 'GIFT_NEED_TARGET':
          (ui.targets || []).forEach(id => addAction(`赠送给 ${roleNameById(id)}`, 'gift_choose_target', { target_id: id }));
          return;
        case 'EXCHANGE_NEED_TARGET':
          (ui.targets || []).forEach(id => addAction(`交换对象 ${roleNameById(id)}`, 'exchange_choose_target', { target_id: id }));
          return;
        case 'EXCHANGE_NEED_CHOICE':
          (ui.options || []).forEach((opt, idx) => addAction(`选 ${opt.label || opt.kind || idx}`, 'exchange_choose_option', { option_index: idx }));
          return;
        case 'EXCHANGE_NEED_CONSENT':
          addAction('同意交换', 'exchange_consent', { agree: true }, 'secondary');
          addAction('拒绝交换', 'exchange_consent', { agree: false });
          return;
        case 'HELP_DECISION':
          addAction('志愿者帮助', 'volunteer_help', { agree: true }, 'secondary');
          addAction('不帮助', 'volunteer_help', { agree: false });
          return;
        default:
          addAction('继续', 'skip_turn');
      }
    }

    function renderLogs() {
      const logs = state.game?.logs || [];
      dom.logs.textContent = logs.join('\n');
      dom.logs.scrollTop = dom.logs.scrollHeight;
    }

    function renderAll() {
      renderMeta();
      renderActions();
      renderArenaPlayers();
      renderLogs();
      dom.setup.style.display = state.game?.game_started ? 'none' : 'block';
    }

    async function refreshState() {
      state.game = await api('/api/game/state');
      renderAll();
    }

    async function doAction(action, params = {}) {
      if (action === 'noop') return;
      if (state.busy) return;
      state.busy = true;
      try {
        state.game = await api('/api/game/action', {
          method: 'POST',
          body: JSON.stringify({ action, params }),
        });
        renderAll();
      } finally {
        state.busy = false;
      }
    }

    function chooseAutoAction(g) {
      if (!g || !g.game_started || g.game_over) return null;
      const ui = g.ui || {};
      const mode = ui.ui_mode || 'TURN';

      const pick = (arr) => Array.isArray(arr) && arr.length ? arr[0] : null;

      switch (mode) {
        case 'TURN':
          if (ui.can_draw) return { action: 'request_draw', params: {} };
          return { action: 'request_no_draw_choice', params: {} };
        case 'NO_DRAW_CHOICE':
          if (ui.has_skill) return { action: 'use_active_skill', params: {} };
          return { action: 'skip_turn', params: {} };
        case 'DRAW_COST_CHOICE':
          return { action: 'choose_draw_cost', params: { index: 0 } };
        case 'EVENT_NEED_TARGET': {
          const t = pick(ui.targets);
          return t ? { action: 'event_choose_target', params: { target_id: t } } : { action: 'skip_turn', params: {} };
        }
        case 'WATCH_DECIDE':
          return { action: 'watch_decide', params: { target_id: ui.target_id, watch: true } };
        case 'PHOTO_NEED_TARGET':
        case 'WEAR_NEED_TARGET': {
          const t = pick(ui.targets);
          return t ? { action: 'photo_choose_target', params: { target_id: t } } : { action: 'skip_turn', params: {} };
        }
        case 'PHOTO_NEED_CONSENT':
          return { action: 'photo_consent', params: { agree: true } };
        case 'TRADE_NEED_ITEM':
          return { action: 'trade_choose_item', params: { item_index: 0 } };
        case 'TRADE_NEED_PARTNER': {
          const p = pick(ui.partners);
          return p ? { action: 'trade_choose_partner', params: { partner_id: p } } : { action: 'skip_turn', params: {} };
        }
        case 'TRADE_NEED_CONSENT':
          return { action: 'trade_consent', params: { agree: true } };
        case 'FOOD_OFFER_DECIDE':
        case 'FOOD_OFFER_FORCE':
          return { action: 'food_offer_decide', params: { target_id: ui.target_id, accept: true } };
        case 'PERFORM_WATCH_DECIDE':
          return { action: 'perform_watch_decide', params: { target_id: ui.target_id, watch: true } };
        case 'PERFORM_WATCH_BENEFIT':
          return { action: 'perform_watch_benefit', params: { target_id: ui.target_id, choice: 'stamina' } };
        case 'GIFT_NEED_TARGET': {
          const t = pick(ui.targets);
          return t ? { action: 'gift_choose_target', params: { target_id: t } } : { action: 'skip_turn', params: {} };
        }
        case 'EXCHANGE_NEED_TARGET': {
          const t = pick(ui.targets);
          return t ? { action: 'exchange_choose_target', params: { target_id: t } } : { action: 'skip_turn', params: {} };
        }
        case 'EXCHANGE_NEED_CHOICE':
          return { action: 'exchange_choose_option', params: { option_index: 0 } };
        case 'EXCHANGE_NEED_CONSENT':
          return { action: 'exchange_consent', params: { agree: true } };
        case 'HELP_DECISION':
          return { action: 'volunteer_help', params: { agree: true } };
        default:
          return { action: 'skip_turn', params: {} };
      }
    }

    async function autoTick() {
      if (state.mode !== 'auto' || state.busy) return;
      const decision = chooseAutoAction(state.game);
      if (!decision) return;
      await doAction(decision.action, decision.params);
    }

    async function startGame() {
      const selectedIds = [...dom.roleChecklist.querySelectorAll('input:checked')].map(x => x.value);
      state.game = await api('/api/game/start', {
        method: 'POST',
        body: JSON.stringify({ selected_role_ids: selectedIds }),
      });
      renderAll();
    }

    async function init() {
      state.roles = await api('/api/roles');
      renderSetup();
      await refreshState();
      setMode('manual');

      dom.startBtn.onclick = startGame;
      dom.resetBtn.onclick = async () => {
        await api('/api/game/reset', { method: 'POST', body: '{}' });
        await refreshState();
      };
      dom.modeManual.onclick = () => setMode('manual');
      dom.modeAuto.onclick = () => setMode('auto');
      dom.stepBtn.onclick = async () => {
        const decision = chooseAutoAction(state.game);
        if (decision) await doAction(decision.action, decision.params);
      };

      window.addEventListener('resize', () => renderArenaPlayers());
    }

    init().catch((err) => {
      console.error(err);
      dom.logs.textContent = String(err);
    });
  </script>
</body>
</html>
